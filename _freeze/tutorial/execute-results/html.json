{
  "hash": "61a707a0c0130f185d4e95d7074ae7eb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Full tutorial\"\n---\n\n\n\n\n\n\n# Importing the data\n\nIn this section we will use the data in the ex_data folder.\nMore ressources on data import are available in [this vignette](https://plant-functional-trait-course.github.io/fluxible/articles/data-prep.html) on the fluxible website.\n\n\n## Importing log file\n\nImporting the log and turning it into a dataframe with chamber ID (port nb), chamber closing time and re-opening time.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n\n# building col names\nchamber_colnames <- c(\n    \"port\", \"valvestatus\", \"chamberstatus\",\n    \"aux1\", \"aux2\", \"aux3\", \"aux4\", \"aux5\",\n    \"temperaturev\", \"pressure\"\n    )\nlog_colnames <- c(\n    \"epochtime\",\n    rep(chamber_colnames, times = 12)\n)\n\nchamber_log_read <- list.files(\n    \"ex_log\",\n    full.names = TRUE\n) |>\n    map_dfr(\n        read_log,\n        col_names = log_colnames\n    )\n# read_log(\"ex_log/FRMonitor_0012.log\", col_names = log_colnames)\n# repeated colnames are normal\nchamber_log_all <- chamber_log_read |>\n    pivot_longer(!c(epochtime), names_to = c(\".value\", \"variable\"), names_sep = \"_\") |>\n    filter(\n        port %in% c(1:12) # we filter out all the rows with port -1\n    ) |>\n    arrange(epochtime) |> # just to be sure\n    mutate( # without grouping\n        change_id = consecutive_id(port, chamberstatus, valvestatus), #detecting all changes in status\n        datetime = as_datetime(epochtime) # we work in datetime\n    ) |>\n    filter(\n        # chamberstatus %in% c(1:3) # very conservative, we can adjust the focus window later in flux_fitting\n        chamberstatus == 1\n        # & valvestatus == 10\n    ) |>\n    mutate(\n        measurement_id = consecutive_id(change_id) # just getting rid of the missing id after filter\n        )\n    \nchamber_log <- chamber_log_all |>\n    mutate(\n        .by = c(measurement_id),\n        closing = min(datetime),\n        opening = max(datetime)\n    ) |>\n    select(measurement_id, port, closing, opening) |>\n    distinct()\n\n# We make a separate df for temp and pressure so we keep the 4 seconds reads\nchamber_temp_pres <- chamber_log_all |>\n    mutate(\n        air_temp = temperaturev * 15, # need to ask the exact conversion factor, for now this one makes sense\n        pressure = pressure / 101.325 # need atm for fluxible\n    ) |>\n    select(datetime, air_temp, pressure)\n\n# View(chamber_log)\n```\n:::\n\n\n\n\nPossible improvements\n\n- take into account the chamber status better and  use it to by-pass the start and end cuts in flux_fitting. Opening and closing status would be \"cut\" (not used for fitting but visible on the plot), and fully open would be \"keep\".\n- keep the other columns\n\n## Importing data file\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_read <- list.files(\n    \"ex_data\",\n    full.names = TRUE\n) |>\n    map_dfr(\n        read_table\n    )\n# read_table(\"ex_data/JFAADS2294-20241211-193921-DataLog_User.dat\")\n\ndata <- data_read |>\n    mutate(\n        f_datetime = as_datetime(paste(DATE, TIME))\n    ) |>\n    left_join(chamber_temp_pres, by = join_by(f_datetime == datetime)) |> # adding air temp and pressure here\n    select(f_datetime, CO2_dry, air_temp, pressure) # we keep it simple for now and work only on CO2\n\n# View(data)\n```\n:::\n\n\n\n\n\n\n# Processing the data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(fluxible)\n\nconc <- flux_match(\n    raw_conc = data,\n    field_record = chamber_log,\n    f_datetime = f_datetime,\n    start_col = closing,\n    end_col = opening,\n    fixed_length = FALSE\n) |>\n    drop_na(CO2_dry)\n# View(conc)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nconc_fit <- flux_fitting(\n    conc_df = conc,\n    f_conc = CO2_dry,\n    fit_type = \"exp_zhao18\",\n    start_cut = 120,\n    end_cut = 240\n)\n#> Cutting measurements...\n#> Estimating starting parameters for optimization...\n#> Optimizing fitting parameters...\n#> Calculating fits and slopes...\n#> Done.\n#> Warning in flux_fitting(conc_df = conc, f_conc = CO2_dry, fit_type = \"exp_zhao18\", : \n#>  fluxID 2 : slope was estimated on 493 points out of 496 seconds\n#>  fluxID 20 : slope was estimated on 453 points out of 488 seconds\n#>  fluxID 22 : slope was estimated on 492 points out of 497 seconds\n#>  fluxID 23 : slope was estimated on 483 points out of 489 seconds\n#>  fluxID 40 : slope is NA, most likely an issue with the model optimization.\n#>         Check your data or use a different model.\n# View(conc_fit)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nconc_flags <- flux_quality(\n    slopes_df = conc_fit,\n    f_conc = CO2_dry,\n    force_discard = c(\n        1:21,\n        40:43\n    )\n)\n#> \n#>  Total number of measurements: 48\n#> \n#>  force_discard \t 24 \t 50 %\n#>  ok \t 18 \t 38 %\n#>  zero \t 4 \t 8 %\n#>  start_error \t 1 \t 2 %\n#>  discard \t 1 \t 2 %\n#>  no_data \t 0 \t 0 %\n#>  force_ok \t 0 \t 0 %\n#>  force_zero \t 0 \t 0 %\n#>  force_lm \t 0 \t 0 %\n#>  no_slope \t 0 \t 0 %\n# View(conc_flags)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nflux_plot(\n    conc_flags,\n    f_conc = CO2_dry,\n    print_plot = FALSE,\n    output = \"pdfpages\",\n    scale_x_datetime_args = list(\n        date_breaks = \"3 min\",\n        minor_breaks = \"1 min\",\n        date_label = \"%e/%m \\n %H:%M\"\n    )\n    )\n\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfluxible_df <- flux_calc(\n    slopes_df = conc_flags,\n    slope_col = f_slope_corr,\n    temp_air_col = air_temp,\n    setup_volume = 72, # not sure if correct, found on website\n    plot_area = 0.21, # to check\n    # atm_pressure = 1,\n    atm_pressure = pressure,\n    conc_unit = \"ppm\",\n    flux_unit = \"umol/m2/s\",\n    cols_keep = \"f_quality_flag\"\n) |>\n    rename(\n        fluxible_flux = \"f_flux\"\n    )\n#> Cutting data according to 'keep_arg'...\n#> Averaging air temperature for each flux...\n#> Creating a df with the columns from 'cols_keep' argument...\n#> Calculating fluxes...\n#> R constant set to 0.082057\n#> Concentration was measured in ppm\n#> Fluxes are in umol/m2/s\n# View(fluxible_df)\n\nsaveRDS(fluxible_df, \"compare_data/fluxible_df.rds\")\n```\n:::\n",
    "supporting": [
      "tutorial_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}