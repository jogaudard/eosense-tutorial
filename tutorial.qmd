---
title: "Full tutorial"
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(tidyverse.quiet = TRUE)
```

# Importing the data

In this section we will use the data in the ex_data folder.
More ressources on data import are available in [this vignette](https://plant-functional-trait-course.github.io/fluxible/articles/data-prep.html) on the fluxible website.


Importing the log and turning it into a dataframe with chamber ID (port nb), chamber closing time and re-opening time.
```{r}
#| label: "import-log"

library(tidyverse)

# building col names
chamber_colnames <- c(
    "port", "valvestatus", "chamberstatus",
    "aux1", "aux2", "aux3", "aux4", "aux5",
    "temperaturev", "pressurev"
    )
log_colnames <- c(
    "epochtime",
    rep(chamber_colnames, times = 12)
)

chamber_log_read <- read_log("ex_log/FRMonitor_0011.log", col_names = log_colnames)
# repeated colnames are normal
chamber_log <- chamber_log_read |>
    pivot_longer(!c(epochtime), names_to = c(".value", "variable"), names_sep = "_") |>
    filter(
        port %in% c(1:12) # we filter out all the rows with port -1
        & chamberstatus %in% c(1:3) # very conservative, we can adjust the focus window later in flux_fitting
    ) |>
    mutate(
        .by = c(port),
        datetime = as_datetime(epochtime), # we work in datetime
        closing = min(datetime),
        opening = max(datetime)
    ) |>
    select(port, closing, opening) |>
    distinct()
```

Possible improvements

- take into account the chamber status better and  use it to by-pass the start and end cuts in flux_fitting. Opening and closing status would be "cut" (not used for fitting but visible on the plot), and fully open would be "keep".
- keep the other columns
- read several log files
- add a measurement ID: in case the same port in used several times in the same log file, the current code will make a very long measurement instead of several (because of group_by port and min max functions)


# Processing the data

<!-- copy tutorial from fluxible -->